---
phase: 02-agent-coordination-dependencies
plan: 04
type: tdd
wave: 4
depends_on: [02-03]
files_modified:
  - tests/integration.rs
autonomous: true
requirements: [STATE-04, COORD-01, COORD-02, COORD-03, COORD-04, COORD-05, COORD-06, TECH-03, TECH-04]

must_haves:
  truths:
    - "Tests prove atomic claiming: concurrent claim attempts result in exactly one success"
    - "Tests prove status machine: every forbidden transition returns InvalidTransition error"
    - "Tests prove cycle detection: adding a circular dep returns CyclicDependency error"
    - "Tests prove release semantics: ticket returns to todo with cleared claim fields"
    - "Tests prove done auto-release: marking done clears claimed_by"
    - "All 13 existing Phase 1 tests still pass"
  artifacts:
    - path: "tests/integration.rs"
      provides: "Integration tests for all Phase 2 behaviors"
      min_lines: 60
  key_links:
    - from: "tests/integration.rs"
      to: "ticket::claim_ticket"
      via: "direct function call with open_test_db() connection"
      pattern: "claim_ticket"
    - from: "tests/integration.rs"
      to: "ticket::would_create_cycle"
      via: "tested through add_dep which calls it"
      pattern: "add_dep"
---

<objective>
Write integration tests for all Phase 2 behaviors added in Plans 02 and 03. Use the existing open_test_db() helper pattern from Phase 1 (tempfile-isolated connections). Tests verify the public API of ticket.rs functions directly — no subprocess spawning needed.

Purpose: Tests catch regressions during future changes and prove the implementation satisfies the coordination requirements. The atomic claim test in particular verifies the `conn.changes() == 0` path for conflict detection.
Output: Extended tests/integration.rs with full Phase 2 coverage. All tests green.
</objective>

<execution_context>
@/Users/marcusmccurdy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcusmccurdy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/02-agent-coordination-dependencies/02-CONTEXT.md
@.planning/phases/02-agent-coordination-dependencies/02-03-SUMMARY.md
@tests/integration.rs
@src/ticket.rs
</context>

<feature>
  <name>Phase 2 integration tests</name>
  <files>tests/integration.rs, src/ticket.rs (read-only reference)</files>
  <behavior>
All tests use the existing open_test_db() helper. Add tests grouped by concern:

**Claim tests:**
- claim_unclaimed_ticket: create ticket, claim it as "agent-1", assert Ok(()), then get_ticket and check claimed_by=Some("agent-1"), status="in-progress"
- claim_already_claimed_returns_error: create ticket, claim as "agent-1", claim again as "agent-2" (no force), assert Err(AppError::AlreadyClaimed(..))
- force_claim_overwrites: create ticket, claim as "agent-1", force-claim as "agent-2", assert Ok(()), get shows claimed_by="agent-2"
- claim_with_unmet_deps_warns_but_succeeds: create two tickets, add dep (2 depends on 1), claim ticket 2 — should succeed (warning goes to stderr, not captured in test; just assert Ok(()))

**Release tests:**
- release_clears_claim_and_resets_todo: create ticket, claim it, release it, get ticket, assert claimed_by=None and status="todo"
- release_wrong_owner_fails: create ticket, claim as "agent-1", release as "agent-2" (no force), assert Err(AppError::NotOwner(..))
- force_release_works: create ticket, claim as "agent-1", force-release as "agent-2", assert Ok(()), get shows no claim

**Status machine tests:**
- done_to_todo_is_invalid: create ticket, update status to "in-progress", update to "done", update to "todo" — last step should return Err(AppError::InvalidTransition(..))
- done_to_in_progress_is_valid: create ticket, in-progress, done, in-progress — all steps Ok(())
- blocked_from_todo_is_valid: create ticket (status=todo), block it with reason, assert Ok(())
- todo_to_done_is_invalid: create ticket, update status directly to "done" (skip in-progress) — should return Err(AppError::InvalidTransition(..))

**Done auto-release test:**
- done_clears_claim: create ticket, claim it, update status to "done", get ticket, assert claimed_by=None

**Dependency tests:**
- add_dep_success: create two tickets, add_dep(2, 1), list_deps(2) — forward=[1], reverse=[]
- remove_dep_success: create two tickets, add_dep(2, 1), remove_dep(2, 1), list_deps(2) — forward=[], reverse=[]
- circular_dep_rejected: create A, B, C; add_dep(B, A); add_dep(C, B); add_dep(A, C) → Err(AppError::CyclicDependency(..))
- self_dep_rejected: create ticket, add_dep(1, 1) → error (either CyclicDependency or Db error from CHECK)
- remove_nonexistent_dep: create ticket, remove_dep(1, 999) → Err(AppError::DepNotFound(..))
- cascade_delete_removes_deps: create two tickets, add_dep(2, 1), delete ticket 1, list_deps(2) — forward=[]
- reverse_deps_populated: create A, B; add_dep(B, A); list_deps(A) → reverse=[B.id]

**Implementation notes:**
- claim_ticket and release_ticket take &mut Connection — the open_test_db() returns Connection; use `let mut conn = open_test_db().0` (destructure the tuple)
- For the concurrent claim test, simulate it sequentially: two separate connections to the same temp file, first claims, second attempts. This tests the SQL logic without actual threading. Use two Connection objects opened to the same TempPath.
- The concurrent test: `let tmp = tempfile::NamedTempFile::new().unwrap(); let path = tmp.path(); let mut conn1 = db::open_connection(path).unwrap(); let mut conn2 = db::open_connection(path).unwrap(); create ticket on conn1; claim on conn1; claim same ticket on conn2 → Err(AlreadyClaimed)`.
  </behavior>
  <implementation>
RED phase: Write all test stubs first. Run `cargo test` — they should all fail to compile or fail with logic errors (since they reference new functions). Commit with message `test(02-04): add failing Phase 2 integration tests`.

GREEN phase: All functions should already be implemented from Plans 02 and 03. Run `cargo test` — all should pass. If any fail, investigate and fix the test (not the implementation) unless the implementation has a bug. Commit with message `test(02-04): all Phase 2 integration tests passing`.

REFACTOR phase: If any tests are duplicative or overly coupled, simplify. Keep each test focused on one behavior. Run `cargo test` again. Commit if changes made: `refactor(02-04): simplify Phase 2 test structure`.
  </implementation>
</feature>

<verification>
`cargo test 2>&1` — all tests pass (count should be ≥ 30: 13 from Phase 1 + ≥17 new Phase 2 tests).
No test references the string "wip" (grep tests/integration.rs for wip — should return nothing).
`cargo test -- --test-output immediate 2>&1` — no panics, no unexpected failures.
</verification>

<success_criteria>
- All Phase 1 tests (13) still pass
- All Phase 2 tests (≥17) pass
- Tests cover: atomic claim conflict, force claim/release, status machine (forbidden and allowed transitions), done auto-release, dep add/remove/cascade, cycle detection, self-dep rejection
- No test uses hardcoded DB paths
- Total test count ≥ 30
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-coordination-dependencies/02-04-SUMMARY.md`
</output>
